name: Daily Marketing Automation

on:
  schedule:
    # Run daily at 9 AM UTC
    - cron: '0 9 * * *'
  workflow_dispatch:
    inputs:
      action:
        description: 'Marketing action to run'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - social
          - blog
          - report

env:
  NODE_VERSION: '20'

jobs:
  generate-and-post:
    name: Generate & Auto-Post Marketing Content
    runs-on: ubuntu-latest
    if: github.event.inputs.action != 'blog' && github.event.inputs.action != 'report'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm install

      - name: Create marketing output directory
        run: mkdir -p marketing-output

      - name: Get latest pricing data
        id: pricing
        run: |
          LATEST_MODEL=$(node -e "const data = require('./src/data/pricing.json'); const model = data.providers[0].models[0]; console.log(model.name);")
          LATEST_PRICE=$(node -e "const data = require('./src/data/pricing.json'); const model = data.providers[0].models[0]; console.log(model.input_per_million);")
          echo "model=$LATEST_MODEL" >> $GITHUB_OUTPUT
          echo "price=$LATEST_PRICE" >> $GITHUB_OUTPUT

      - name: Auto-post to social media
        env:
          TWITTER_API_KEY: ${{ secrets.TWITTER_API_KEY }}
          TWITTER_API_SECRET: ${{ secrets.TWITTER_API_SECRET }}
          TWITTER_ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
          TWITTER_ACCESS_SECRET: ${{ secrets.TWITTER_ACCESS_SECRET }}
          LINKEDIN_ACCESS_TOKEN: ${{ secrets.LINKEDIN_ACCESS_TOKEN }}
          REDDIT_USERNAME: ${{ secrets.REDDIT_USERNAME }}
          REDDIT_PASSWORD: ${{ secrets.REDDIT_PASSWORD }}
          REDDIT_CLIENT_ID: ${{ secrets.REDDIT_CLIENT_ID }}
          REDDIT_CLIENT_SECRET: ${{ secrets.REDDIT_CLIENT_SECRET }}
        run: |
          echo "=== Auto-posting for ${{ steps.pricing.outputs.model }} at $${{ steps.pricing.outputs.price }}/M ==="
          npx tsx scripts/marketing/auto-post.ts OpenAI "${{ steps.pricing.outputs.model }}" "${{ steps.pricing.outputs.price }}" > marketing-output/auto-post-results.txt
          cat marketing-output/auto-post-results.txt

      - name: Generate social posts (backup)
        run: |
          npx tsx scripts/marketing/social-poster.ts OpenAI "${{ steps.pricing.outputs.model }}" "${{ steps.pricing.outputs.price }}" > marketing-output/social-posts.txt
          echo "✅ Social posts generated"

      - name: Generate content calendar
        run: |
          npx tsx scripts/marketing/blog-ideas.ts calendar > marketing-output/content-calendar.txt
          npx tsx scripts/marketing/blog-ideas.ts keywords > marketing-output/keyword-clusters.txt
          npx tsx scripts/marketing/blog-ideas.ts linking > marketing-output/internal-linking.txt
          npx tsx scripts/marketing/blog-ideas.ts meta > marketing-output/meta-descriptions.txt
          npx tsx scripts/marketing/blog-ideas.ts brief 1 > marketing-output/brief-1.txt
          echo "✅ Content calendar generated"

      - name: Generate directory checklist
        run: |
          npx tsx scripts/marketing/directory-submitter.ts checklist > marketing-output/directory-checklist.txt
          npx tsx scripts/marketing/directory-submitter.ts data > marketing-output/directory-data.json
          echo "✅ Directory checklist generated"

      - name: Generate outreach plan
        run: |
          npx tsx scripts/marketing/backlink-outreach.ts plan > marketing-output/outreach-plan.txt
          echo "=== Sample Email: Futurepedia ===" > marketing-output/sample-emails.txt
          npx tsx scripts/marketing/backlink-outreach.ts email "Futurepedia" >> marketing-output/sample-emails.txt
          echo "" >> marketing-output/sample-emails.txt
          echo "=== Sample Email: Product Hunt ===" >> marketing-output/sample-emails.txt
          npx tsx scripts/marketing/backlink-outreach.ts email "Product Hunt" >> marketing-output/sample-emails.txt
          echo "" >> marketing-output/sample-emails.txt
          echo "=== Sample Email: Hacker News ===" >> marketing-output/sample-emails.txt
          npx tsx scripts/marketing/backlink-outreach.ts email "Hacker News" >> marketing-output/sample-emails.txt
          echo "✅ Outreach plan generated"

      - name: Generate daily report
        run: |
          cat > marketing-output/DAILY_MARKETING_REPORT.md << 'ENDOFREPORT'
          # Daily Marketing Report - LLM PriceCompare
          Generated: $(date -u +"%Y-%m-%d %H:%M UTC")

          ## Today's Automated Tasks

          1. Social Media Posts
             - Posted to Twitter/X, LinkedIn, Reddit (if API credentials configured)
             - Backup posts available in social-posts.txt

          2. Content Marketing
             - 30-day content calendar
             - Keyword clusters for SEO
             - Internal linking strategy
             - Meta descriptions
             - Content brief for post #1

          3. Directory Submissions
             - 21 directories with submission details
             - Priority order for quick wins

          4. Outreach Plan
             - 20 outreach targets
             - 3 email templates ready

          ## Expected Results
          - Daily social media engagement
          - Directory submissions this week
          - Backlink opportunities
          - Content publishing schedule

          ## Next Steps (Fully Automated)
          All tasks are generated automatically daily at 9 AM UTC.
          No manual work required - just review artifacts and execute.

          ---
          Auto-generated daily by GitHub Actions
          ENDOFREPORT
          echo "✅ Daily report generated"

      - name: Upload all artifacts
        uses: actions/upload-artifact@v4
        with:
          name: marketing-daily-${{ github.run_number }}
          path: marketing-output/
          retention-days: 7

  generate-content-briefs:
    name: Generate Blog Content Briefs
    runs-on: ubuntu-latest
    if: github.event.inputs.action != 'social' && github.event.inputs.action != 'report'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm install

      - name: Generate content calendar
        run: |
          mkdir -p marketing-output
          npx tsx scripts/marketing/blog-ideas.ts calendar > marketing-output/content-calendar.txt
          npx tsx scripts/marketing/blog-ideas.ts keywords > marketing-output/keyword-clusters.txt
          npx tsx scripts/marketing/blog-ideas.ts linking > marketing-output/internal-linking.txt
          npx tsx scripts/marketing/blog-ideas.ts meta > marketing-output/meta-descriptions.txt
          npx tsx scripts/marketing/blog-ideas.ts brief 1 > marketing-output/brief-1.txt

      - name: Upload content artifacts
        uses: actions/upload-artifact@v4
        with:
          name: content-briefs-${{ github.run_number }}
          path: marketing-output/
          retention-days: 14

  generate-marketing-report:
    name: Generate Marketing Report
    runs-on: ubuntu-latest
    if: github.event.inputs.action != 'social' && github.event.inputs.action != 'blog'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm install

      - name: Generate marketing report
        run: |
          mkdir -p marketing-output

          cat > marketing-output/DAILY_MARKETING_REPORT.md << 'ENDOFREPORT'
          # Daily Marketing Report - LLM PriceCompare
          Generated: $(date -u +"%Y-%m-%d %H:%M UTC")

          ## Quick Actions Today

          1. Social Media (9 AM UTC)
             Auto-posting enabled via GitHub Actions secrets.
             Posts generated daily for Twitter/X, LinkedIn, Reddit.

          2. Directory Submissions (Priority Order)
             1. Futurepedia (AI directory) - 10 min
             2. ThereIsAnAIForThat - 10 min
             3. DevHunt (dev tools) - 10 min
             4. Product Hunt - 15 min
             5. BetaList - 10 min

          3. Content Creation
             - Today's recommended post: LLM Pricing Comparison 2026
             - Keywords: llm pricing comparison, openai pricing, ai cost
             - Brief: See content-briefs artifact

          4. Outreach Targets
             - Futurepedia (directory add)
             - Product Hunt (resource link)
             - Hacker News (Show HN post)

          ## Metrics to Track
          - Social media engagement
          - Directory submissions completed
          - Backlinks acquired
          - Blog post published
          - Traffic from referrals

          ## Weekly Goals
          - 5+ directory listings
          - 2+ social posts per day
          - 1 blog post per week
          - 10+ backlinks per week

          ## Tools Available
          - Social poster: scripts/marketing/social-poster.ts
          - Auto-post: scripts/marketing/auto-post.ts
          - Directory submitter: scripts/marketing/directory-submitter.ts
          - Blog ideas: scripts/marketing/blog-ideas.ts
          - Outreach: scripts/marketing/backlink-outreach.ts

          ---
          This report is auto-generated daily by GitHub Actions
          ENDOFREPORT

          echo "## Marketing Report" >> $GITHUB_STEP_SUMMARY
          echo "✅ Daily marketing tasks generated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts Available" >> $GITHUB_STEP_SUMMARY
          echo "- Social media posts (auto-post + backup)" >> $GITHUB_STEP_SUMMARY
          echo "- Content briefs & calendar" >> $GITHUB_STEP_SUMMARY
          echo "- Directory submission checklist" >> $GITHUB_STEP_SUMMARY
          echo "- Outreach plan & email templates" >> $GITHUB_STEP_SUMMARY
          echo "- Daily marketing report" >> $GITHUB_STEP_SUMMARY

      - name: Upload report
        uses: actions/upload-artifact@v4
        with:
          name: marketing-report-${{ github.run_number }}
          path: marketing-output/
          retention-days: 7

  notify-completion:
    name: Notify Completion
    runs-on: ubuntu-latest
    needs: [generate-and-post, generate-content-briefs, generate-marketing-report]
    if: always()

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Create summary
        run: |
          echo "# Marketing Automation Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## All Tasks Generated Automatically" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Generated Files" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Social Media" >> $GITHUB_STEP_SUMMARY
          echo "- Auto-post results (with API credentials)" >> $GITHUB_STEP_SUMMARY
          echo "- Backup social posts for manual use" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Content Marketing" >> $GITHUB_STEP_SUMMARY
          echo "- 30-day content calendar" >> $GITHUB_STEP_SUMMARY
          echo "- Keyword clusters" >> $GITHUB_STEP_SUMMARY
          echo "- Internal linking strategy" >> $GITHUB_STEP_SUMMARY
          echo "- Meta descriptions" >> $GITHUB_STEP_SUMMARY
          echo "- Content brief #1" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Directory Submissions" >> $GITHUB_STEP_SUMMARY
          echo "- Checklist with 21 directories" >> $GITHUB_STEP_SUMMARY
          echo "- Submission data JSON" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Outreach" >> $GITHUB_STEP_SUMMARY
          echo "- Outreach plan" >> $GITHUB_STEP_SUMMARY
          echo "- 3 sample email templates" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Reports" >> $GITHUB_STEP_SUMMARY
          echo "- Daily marketing report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Zero Manual Work Required" >> $GITHUB_STEP_SUMMARY
          echo "All marketing materials are generated automatically daily at 9 AM UTC." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "To Enable Auto-Posting:" >> $GITHUB_STEP_SUMMARY
          echo "Add these GitHub secrets:" >> $GITHUB_STEP_SUMMARY
          echo "- TWITTER_API_KEY, TWITTER_API_SECRET, TWITTER_ACCESS_TOKEN, TWITTER_ACCESS_SECRET" >> $GITHUB_STEP_SUMMARY
          echo "- LINKEDIN_ACCESS_TOKEN" >> $GITHUB_STEP_SUMMARY
          echo "- REDDIT_USERNAME, REDDIT_PASSWORD, REDDIT_CLIENT_ID, REDDIT_CLIENT_SECRET" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Without API Credentials:" >> $GITHUB_STEP_SUMMARY
          echo "The workflow still generates all content for manual posting." >> $GITHUB_STEP_SUMMARY
