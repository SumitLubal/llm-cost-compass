name: Daily Pricing Update

on:
  # Run daily at 9 AM UTC
  schedule:
    - cron: '0 9 * * *'

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      auto_publish:
        description: 'Auto-publish if confidence > 90%?'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'
      alert_email:
        description: 'Email for alerts (optional)'
        required: false
        type: string

# Concurrency: cancel in-progress runs
concurrency:
  group: daily-update
  cancel-in-progress: false

jobs:
  update-pricing:
    runs-on: ubuntu-latest

    # Set permissions for git commits
    permissions:
      contents: write
      pull-requests: write

    steps:
      # 1. Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      # 2. Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      # 3. Install dependencies
      - name: Install dependencies
        run: npm ci

      # 4. Run daily update
      - name: Run daily pricing update
        id: update
        env:
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
          ALERT_EMAIL: ${{ github.event.inputs.alert_email || secrets.ALERT_EMAIL || 'sumitlubal@hotmail.com' }}
        run: |
          # Determine auto-publish flag
          AUTO_PUBLISH="${{ github.event.inputs.auto_publish || 'false' }}"

          echo "Running daily update..."
          echo "Auto-publish: $AUTO_PUBLISH"
          echo "Alert email: $ALERT_EMAIL"

          # Run the update script
          npx tsx scripts/daily-update.ts $ALERT_EMAIL $([ "$AUTO_PUBLISH" = "true" ] && echo "--auto-publish" || echo "")

          # Capture output for next steps
          echo "auto_publish=$AUTO_PUBLISH" >> $GITHUB_OUTPUT

      # 5. Check for changes
      - name: Check for changes
        id: changes
        run: |
          if git diff --quiet src/data/pricing.json; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes to pricing.json"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected in pricing.json"
          fi

      # 6. Commit and push (if auto-publish enabled)
      - name: Commit updated pricing data
        if: steps.changes.outputs.has_changes == 'true' && github.event.inputs.auto_publish == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          git add src/data/pricing.json
          git commit -m "chore: auto-update pricing data $(date -u +'%Y-%m-%d %H:%M UTC')"
          git push

      # 7. Create Pull Request (if auto-publish disabled)
      - name: Create Pull Request
        if: steps.changes.outputs.has_changes == 'true' && github.event.inputs.auto_publish != 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: pricing data update $(date -u +'%Y-%m-%d')"
          title: "ðŸ“Š Pricing Update - $(date -u +'%Y-%m-%d')"
          body: |
            ## Daily Pricing Update

            This PR contains pricing changes detected on $(date -u +'%Y-%m-%d').

            ### Changes
            - Run the daily update script
            - Review changes in `src/data/pricing.json`
            - Approve if correct

            ### Review Checklist
            - [ ] Verify prices against provider websites
            - [ ] Check confidence scores
            - [ ] Approve or request changes

            ---
            *This PR was auto-generated by GitHub Actions*
          branch: automated/pricing-update-$(date -u +%Y%m%d)
          delete-branch: true

      # 8. Upload artifacts (for debugging)
      - name: Upload pricing data
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pricing-data-${{ github.run_number }}
          path: src/data/pricing.json
          retention-days: 7

      # 9. Summary
      - name: Job Summary
        run: |
          echo "## Daily Pricing Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Date**: $(date -u +'%Y-%m-%d %H:%M UTC')" >> $GITHUB_STEP_SUMMARY
          echo "- **Auto-publish**: ${{ github.event.inputs.auto_publish || 'false' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Changes detected**: ${{ steps.changes.outputs.has_changes }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.changes.outputs.has_changes }}" == "true" ]; then
            if [ "${{ github.event.inputs.auto_publish }}" == "true" ]; then
              echo "âœ… Changes committed directly to main" >> $GITHUB_STEP_SUMMARY
            else
              echo "ðŸ“ Pull request created for review" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âœ… No changes detected" >> $GITHUB_STEP_SUMMARY
          fi
